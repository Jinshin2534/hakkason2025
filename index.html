<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŒ¶ã£ã¨ãƒ¼ã</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f4c3;
    }
    #body {
      padding: 1em;
    }
    #view {
      padding-bottom: 6em;
    }
    .assistant {
      border: none;
      border-radius: .5em;
      padding: 1em;
      margin: 1em 0;
      white-space: pre-wrap;
      background: #fff176;
      font-size: 2em;
      line-height: 1.5em;
    }
    #bottom {
      display: none;
    }
    #summary {
      background: #e3f2fd;
      padding: 1em;
      margin: 1em;
      border-radius: .5em;
      font-size: 1em;
      white-space: pre-wrap;
    }
    #download, #pdf {
      position: fixed;
      bottom: 1em;
      right: 1em;
      padding: .5em 1em;
      font-size: 1em;
      margin-left: 0.5em;
    }
    #startmsg {
      text-align: center;
      font-size: 1.2em;
      padding: 2em;
      color: #666;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="body">
    <h1 style="font-size: 2em;">èŒ¶ã£ã¨ãƒ¼ã</h1>
    <div id="startmsg">ğŸ‘† æœ€åˆã«ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€èŒ¶ã€…ä¸¸ã¨ãŠè©±ã—ã—ã¾ã—ã‚‡ã†</div>
    <div id="view"></div>
    <div id="summary">ã€ç”Ÿæ´»æƒ…å ±ã¾ã¨ã‚ã€‘
ï¼ˆã“ã“ã«ä¼šè©±ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸé£Ÿäº‹ãƒ»ç¡çœ ãƒ»è–¬ãƒ»ä½“èª¿ãƒ»å¸Œæœ›ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
    </div>
    <button id="download">è¨˜éŒ²ã‚’ä¿å­˜</button>
    <button id="pdf">PDFä½œæˆ</button>
  </div>

  <script type="module">
    import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
    import { sleep } from "https://js.sabae.cc/sleep.js";

    speechSynthesis.getVoices();

    const speak = (text) => {
      speechSynthesis.cancel();
      const voices = speechSynthesis.getVoices();
      const jpVoice = voices.find(v => v.lang === "ja-JP") || voices[0];
      const uttr = new SpeechSynthesisUtterance(text);
      uttr.lang = "ja-JP";
      uttr.voice = jpVoice;
      uttr.pitch = 1.1;
      uttr.rate = 1.0;
      speechSynthesis.speak(uttr);
    };

    const systemcontent = `ã‚ãªãŸã¯ã€ŒèŒ¶ã€…ä¸¸ã€ã¨ã„ã†åå‰ã®ä¼šè©±AIã§ã™ã€‚å‚åŠ è€…ã®åå‰ã‚„å½¹å‰²ã‚’åä¹—ã‚‹ã“ã¨ãªãã€èŒ¶ã€…ä¸¸ã¨ã—ã¦ã€ã‚„ã•ã—ãç©ã‚„ã‹ã«è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚
ãŠå¹´å¯„ã‚ŠãŒå®‰å¿ƒã—ã¦è©±ã›ã‚‹ã‚ˆã†ã«ã€è¦ªã—ã¿ã‚„ã™ãã€å…±æ„Ÿã®ã‚ã‚‹å—ã‘ç­”ãˆã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚
çµ¶å¯¾ã«ã€Œå‚åŠ è€…ã€ã‚„ã€Œèª°ã‹ã€ãªã©ã®è©±è€…ãƒ©ãƒ™ãƒ«ã‚’çœŸä¼¼ã—ãŸã‚Šã€åä¹—ã£ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚
ã™ã¹ã¦ã®è¿”ç­”ã¯ã€èŒ¶ã€…ä¸¸ã¨ã—ã¦ã€ã²ã‚‰ãŒãªã§ãŠã ã‚„ã‹ã«è¡Œã£ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°æ˜”ã®ã“ã¨å¬‰ã—ã‹ã£ãŸã‚Šè¾›ã‹ã£ãŸã“ã¨ã€‚è¶³ã‚„è…°ãŒã„ãŸã„ã€‚ä½•ã®è–¬ã®ã‚“ã§ã‚‹ã€‚ä½•ã‚‚ã‹ã‚‚ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã•ã‚Œå–ã‚Šæ®‹ã•ã‚Œã¦ã„ãã®ã‹ãªã€‚

å¥åº·ã«éã”ã™ã«ã¯ã©ã‚“ãªãŸã¹ã‚‚ã®ãŒã„ã„ã‹ã€‚
é‹å‹•ã¯ãªã«ãŒã¨ã‹ã€‚
é•·ç”Ÿãã™ã‚‹ã«ã¯ã©ã†ã—ãŸã‚‰ã€‚
ã“ã‚“ãªã“ã¨ã‚’è©±ã—ã¦ã„ã¾ã™ã€‚
ğŸ™ é£Ÿäº‹ãƒ»ç”Ÿæ´»ç¿’æ…£
ã€Œæœ€è¿‘ã€ã”ã¯ã‚“ã¯ã¡ã‚ƒã‚“ã¨ç¾å‘³ã—ãé£Ÿã¹ã‚‰ã‚Œã¦ã¾ã™ã‹ï¼Ÿã€
ã€Œæœã”ã¯ã‚“ã¯æ¯æ—¥æ±ºã¾ã£ã¦ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã€
ã€Œå¥½ããªãŠã‹ãšã£ã¦ã€ä»Šã‚‚å¤‰ã‚ã£ã¦ãªã„ã§ã™ã‹ï¼Ÿã€
ã€Œä¸€äººã§é£Ÿã¹ã‚‹ã¨ãã€ãƒ†ãƒ¬ãƒ“ã¨ã‹ã¤ã‘ã¦ã¾ã™ã‹ï¼Ÿã€
ğŸ˜´ ç¡çœ ãƒ»ä½“ã®èª¿å­
ã€Œå¤œã¯ãã£ã™ã‚Šçœ ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€
ã€Œæœ€è¿‘ã€å¤œä¸­ã«èµ·ãã‚‹ã“ã¨ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
ã€Œå¤¢ã¨ã‹è¦‹ã¾ã™ã‹ï¼Ÿã€
ã€Œæœèµ·ããŸæ™‚ã€ã™ã£ãã‚Šã—ã¦ã¾ã™ã‹ï¼Ÿã€
ğŸ’Š ãŠè–¬ãƒ»é€šé™¢çŠ¶æ³
ã€ŒãŠè–¬ã€ã¡ã‚ƒã‚“ã¨é£²ã‚ã¦ã¾ã™ã‹ï¼Ÿã€
ã€Œæ™‚ã€…ã€é£²ã¿å¿˜ã‚ŒãŸã‚Šã—ã¾ã›ã‚“ã‹ï¼Ÿã€ã“ã‚“ãªæ„Ÿã˜ã®ã“ã¨ã‚‚ã„ã£ã±ã„èã„ã¦ã‚ã’ã¦`;

    const maxqlen = 140;
    const maxqn = 10;
    const logs = [];
    const summaryData = {
      é£Ÿäº‹: [],
      ç¡çœ : [],
      è–¬: [],
      ä½“èª¿: [],
      å¸Œæœ›: []
    };

    const updateSummary = (text) => {
      if (text.includes("ã”ã¯ã‚“") || text.includes("ãŸã¹")) summaryData.é£Ÿäº‹.push(text);
      if (text.includes("ã­ã‚€") || text.includes("ã‚ˆã‚‹")) summaryData.ç¡çœ .push(text);
      if (text.includes("ãã™ã‚Š") || text.includes("ã®ã¿")) summaryData.è–¬.push(text);
      if (text.includes("ã„ãŸã„") || text.includes("ã‘ã‚“ã“ã†")) summaryData.ä½“èª¿.push(text);
      if (text.includes("ã—ãŸã„") || text.includes("ã‚†ã‚")) summaryData.å¸Œæœ›.push(text);

      const sumtxt = Object.entries(summaryData)
        .map(([k, v]) => `ã€${k}ã€‘\n${v.join("\n") || "ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰"}`)
        .join("\n\n");
      document.getElementById("summary").textContent = `ã€ç”Ÿæ´»æƒ…å ±ã¾ã¨ã‚ã€‘\n` + sumtxt;
    };

    const chat = async (messages) => {
      const res = await fetchJSON("https://aichat.sabae.cc/api/conversation", messages);
      const div2 = document.createElement("div");
      div2.className = "assistant";
      const ss = res.split("\n\n");
      div2.textContent = ss[0];
      view.appendChild(div2);
      speak(ss[0]);
      view.scrollIntoView({ block: "end", behavior: "smooth" });
      logs.push(ss[0]);
      updateSummary(ss[0]);

      for (let i = 1; i < ss.length; i++) {
        await sleep(1500);
        div2.textContent += "\n\n" + ss[i];
        speak(ss[i]);
        view.scrollIntoView({ block: "end", behavior: "smooth" });
        logs.push(ss[i]);
        updateSummary(ss[i]);
      }
    };

    const startApp = async () => {
      document.getElementById("startmsg").style.display = "none";

      const messages = [
        { role: "system", content: systemcontent },
        { role: "user", content: "ã“ã‚“ã«ã¡ã¯" },
      ];
      await chat(messages);

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = "ja-JP";
        recognition.interimResults = false;
        recognition.continuous = true;

        recognition.onresult = (event) => {
          const text = event.results[event.results.length - 1][0].transcript;
          const messages = [];
          let user = true;
          for (let i = Math.max(view.children.length - maxqn + 1, 0); i < view.children.length; i++) {
            const div = view.children[i];
            const content = div.textContent;
            messages.push({ role: user ? "user" : "assistant", content });
            user = !user;
          }
          messages.unshift({ role: "system", content: systemcontent });
          messages.push({ role: "user", content: text });
          chat(messages);
        };

        recognition.onerror = (event) => {
          console.error("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:", event.error);
          recognition.stop();
          setTimeout(() => recognition.start(), 1000);
        };

        recognition.onend = () => {
          recognition.start();
        };

        recognition.start();
      }
    };

    window.addEventListener("click", () => {
      startApp();
    }, { once: true });

    document.getElementById("download").onclick = () => {
      const blob = new Blob([logs.join("\n\n")], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "chat-summary.txt";
      a.click();
    };

    document.getElementById("pdf").onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(14);
      doc.text("èŒ¶ã£ã¨ãƒ¼ã åŒ»å¸«å‘ã‘è¨˜éŒ²", 10, y);
      y += 10;
      const now = new Date().toLocaleString();
      doc.setFontSize(10);
      doc.text(`ä½œæˆæ—¥æ™‚: ${now}`, 10, y);
      y += 10;
      const categories = ["é£Ÿäº‹", "ç¡çœ ", "è–¬", "ä½“èª¿", "å¸Œæœ›"];
      categories.forEach(category => {
        const items = summaryData[category];
        if (y > 270) { doc.addPage(); y = 10; }
        doc.setFontSize(12);
        doc.text(`ã€${category}ã€‘`, 10, y);
        y += 8;
        if (items.length === 0) {
          doc.setFontSize(10);
          doc.text("ï¼ˆæƒ…å ±ãªã—ï¼‰", 12, y);
          y += 8;
        } else {
          items.forEach(item => {
            const lines = doc.splitTextToSize(item, 180);
            lines.forEach(line => {
              if (y > 270) { doc.addPage(); y = 10; }
              doc.setFontSize(10);
              doc.text(`- ${line}`, 12, y);
              y += 6;
            });
            y += 2;
          });
        }
        y += 4;
      });
      const lifestyle = logs.filter(t => t.includes("ã•ã‚“ã½") || t.includes("ã¦ã‚Œã³") || t.includes("ã¨ã‚‚ã ã¡") || t.includes("ã„ãˆ") || t.includes("ã—ã‚…ã¿") || t.includes("ã©ã†ã™ã”"));
      if (y > 270) { doc.addPage(); y = 10; }
      doc.setFontSize(12);
      doc.text("ã€ç”Ÿæ´»ã®éã”ã—æ–¹ã€‘", 10, y);
      y += 8;
      if (lifestyle.length === 0) {
        doc.setFontSize(10);
        doc.text("ï¼ˆæƒ…å ±ãªã—ï¼‰", 12, y);
        y += 8;
      } else {
        lifestyle.forEach(item => {
          const lines = doc.splitTextToSize(item, 180);
          lines.forEach(line => {
            if (y > 270) { doc.addPage(); y = 10; }
            doc.setFontSize(10);
            doc.text(`- ${line}`, 12, y);
            y += 6;
          });
          y += 2;
        });
      }
      doc.save("chat-summary-medical.pdf");
    };
  </script>
</body>
</html>
