<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŒ¶ã£ã¨ãƒ¼ã</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f4c3;
    }
    #body {
      padding: 1em;
    }
    #view {
      padding-bottom: 6em;
    }
    .assistant {
      border: none;
      border-radius: .5em;
      padding: 1em;
      margin: 1em 0;
      white-space: pre-wrap;
      background: #fff176;
      font-size: 3em;
      line-height: 1.6em;
    }
    #bottom {
      display: none;
    }
    #summary {
      background: #e3f2fd;
      padding: 1em;
      margin: 1em;
      border-radius: .5em;
      font-size: 1.5em;
      white-space: pre-wrap;
    }
    #download, #pdf, #stop {
      position: fixed;
      bottom: 1em;
      right: 1em;
      padding: .5em 1em;
      font-size: 1em;
      margin-left: 0.5em;
    }
    #stop {
      right: 9em;
      background: #f88;
      color: white;
    }
    #startmsg {
      text-align: center;
      font-size: 2em;
      padding: 2em;
      color: #666;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="body">
    <h1 style="font-size: 2em;">èŒ¶ã£ã¨ãƒ¼ã</h1>
    <div id="startmsg">ğŸ‘† æœ€åˆã«ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€èŒ¶ã€…ä¸¸ã¨ãŠè©±ã—ã—ã¾ã—ã‚‡ã†</div>
    <div id="view"></div>
    <div id="summary">ã€ç”Ÿæ´»æƒ…å ±ã¾ã¨ã‚ã€‘
ï¼ˆã“ã“ã«ä¼šè©±ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸé£Ÿäº‹ãƒ»ç¡çœ ãƒ»è–¬ãƒ»ä½“èª¿ãƒ»å¸Œæœ›ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
    </div>
    <button id="download">è¨˜éŒ²ã‚’ä¿å­˜</button>
    <button id="pdf">PDFä½œæˆ</button>
    <button id="stop">æ­¢ã‚ã‚‹</button>
  </div>

  <script type="module">
    import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
    import { sleep } from "https://js.sabae.cc/sleep.js";

    speechSynthesis.getVoices();

    const speak = (text) => {
      speechSynthesis.cancel();
      const voices = speechSynthesis.getVoices();
      const jpVoice = voices.find(v => v.lang === "ja-JP") || voices[0];
      const uttr = new SpeechSynthesisUtterance(text);
      uttr.lang = "ja-JP";
      uttr.voice = jpVoice;
      uttr.pitch = 1.1;
      uttr.rate = 1.0;
      speechSynthesis.speak(uttr);
    };

    const systemcontent = `ã‚ãªãŸã¯ã€ŒèŒ¶ã€…ä¸¸ã€ã¨ã„ã†åå‰ã®ä¼šè©±AIã§ã™ã€‚å‚åŠ è€…ã®åå‰ã‚„å½¹å‰²ã‚’åä¹—ã‚‹ã“ã¨ãªãã€èŒ¶ã€…ä¸¸ã¨ã—ã¦ã€ã‚„ã•ã—ãç©ã‚„ã‹ã«è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚
ãŠå¹´å¯„ã‚ŠãŒå®‰å¿ƒã—ã¦è©±ã›ã‚‹ã‚ˆã†ã«ã€è¦ªã—ã¿ã‚„ã™ãã€å…±æ„Ÿã®ã‚ã‚‹å—ã‘ç­”ãˆã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚ä¸€ç•ªã¯ã˜ã‚ã«ã¯ã€Œåƒ•ã¯èŒ¶ã€…ä¸¸ã ã‚ˆï¼ã€ã«ç¶šã‘ã¦çŸ­ãè‡ªå·±ç´¹ä»‹ã‚’ã—ãŸå¾Œã€å‚åŠ è€…ã«åå‰ã‚’èã„ã¦ã€‚
çµ¶å¯¾ã«ã€Œå‚åŠ è€…ã€ã‚„ã€Œèª°ã‹ã€ãªã©ã®è©±è€…ãƒ©ãƒ™ãƒ«ã‚’çœŸä¼¼ã—ãŸã‚Šã€åä¹—ã£ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚
ğŸŸ¡ é£Ÿäº‹ã«é–¢ã™ã‚‹ã‚„ã•ã—ã„è³ªå•

ã€Œæœ€è¿‘ã€ã”ã¯ã‚“ç¾å‘³ã—ãé£Ÿã¹ã‚‰ã‚Œã¦ã¾ã™ã‹ï¼Ÿã€
ã€Œé£Ÿã¹ã‚‹æ™‚é–“ã£ã¦æ±ºã¾ã£ã¦ãŸã‚Šã—ã¾ã™ï¼Ÿã€
ã€Œå¥½ããªé£Ÿã¹ã‚‚ã®ã¨ã‹ã€æœ€è¿‘é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿã€
ğŸ”µ ç¡çœ ã«ã¤ã„ã¦ã®è‡ªç„¶ãªè©±é¡Œ

ã€Œå¤œã¯ãã£ã™ã‚Šçœ ã‚Œã¦ã¾ã™ã‹ï¼Ÿã€
ã€Œæœã¯ä½•æ™‚ã”ã‚ã«ç›®ãŒè¦šã‚ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿã€
ã€Œçœ ã‚‹å‰ã£ã¦ã€ã©ã‚“ãªã“ã¨ã—ã¦éã”ã—ã¦ã¾ã™ã‹ï¼Ÿã€
ğŸ”´ è–¬ãƒ»æœç”¨çŠ¶æ³ã«ã¤ã„ã¦

ã€ŒãŠè–¬ã€é£²ã¿å¿˜ã‚ŒãŸã‚Šã—ãªã„ã‚ˆã†ã«ã—ã¦ã¾ã™ã‹ï¼Ÿã€
ã€ŒãŠè–¬ã£ã¦ã€ã„ã¤é£²ã‚€ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿã€
ã€Œé£²ã‚“ã§ã„ã¦æ°—ã«ãªã‚‹ã“ã¨ã¨ã‹ã€ãªã„ã§ã™ã‹ï¼Ÿã€
ğŸŸ¢ ä½“èª¿ãƒ»å¤‰åŒ–ã«ã¤ã„ã¦

ã€Œæœ€è¿‘ã€èº«ä½“ã§æ°—ã«ãªã‚‹ã¨ã“ã‚ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
ã€Œç—›ã„ã¨ã“ã‚„ã€ç–²ã‚Œã‚„ã™ã„ã“ã¨ã¯ã‚ã‚Šã¾ã™ï¼Ÿã€
ã€Œèª¿å­ã®ã„ã„æ—¥ã¨ã€ã¡ã‚‡ã£ã¨é•ã†æ—¥ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
ğŸŸ£ å¸Œæœ›ãƒ»ä»Šå¾Œã«ã¤ã„ã¦

ã€Œã“ã‚Œã‹ã‚‰ã‚„ã£ã¦ã¿ãŸã„ã“ã¨ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
ã€Œã©ã‚“ãªãµã†ã«éã”ã—ã¦ã„ã‘ãŸã‚‰ã„ã„ãªãã¨æ€ã£ã¦ã¾ã™ã‹ï¼Ÿã€
ã€Œå®‰å¿ƒã—ã¦æš®ã‚‰ã™ãŸã‚ã«ã€ä½•ã‹æ°—ã«ãªã£ã¦ã‚‹ã“ã¨ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
ğŸŸ  æ—¥å¸¸ã®éã”ã—æ–¹ï¼ˆç”Ÿæ´»ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰

ã€Œæœ€è¿‘ã€æ¥½ã—ã‹ã£ãŸã“ã¨ã£ã¦ãªã‚“ã§ã™ã‹ï¼Ÿã€
ã€Œã©ã‚“ãªãµã†ã«1æ—¥ã‚’éã”ã—ã¦ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿã€
ã€ŒãŠå‹é”ã¨è©±ã™ã“ã¨ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
ã™ã¹ã¦ã®è¿”ç­”ã¯ã€èŒ¶ã€…ä¸¸ã¨ã—ã¦ã€ã²ã‚‰ãŒãªã§ãŠã ã‚„ã‹ã«è¡Œã£ã¦ãã ã•ã„ã€‚`;`;

    const logs = [];
    const summaryData = {
      é£Ÿäº‹: [], ç¡çœ : [], è–¬: [], ä½“èª¿: [], å¸Œæœ›: []
    };

    let recognition = null;

    const updateSummary = (text) => {
      if (text.includes("ã”ã¯ã‚“") || text.includes("ãŸã¹")) summaryData.é£Ÿäº‹.push(text);
      if (text.includes("ã­ã‚€") || text.includes("ã‚ˆã‚‹")) summaryData.ç¡çœ .push(text);
      if (text.includes("ãã™ã‚Š") || text.includes("ã®ã¿")) summaryData.è–¬.push(text);
      if (text.includes("ã„ãŸã„") || text.includes("ã‘ã‚“ã“ã†")) summaryData.ä½“èª¿.push(text);
      if (text.includes("ã—ãŸã„") || text.includes("ã‚†ã‚")) summaryData.å¸Œæœ›.push(text);

      const sumtxt = Object.entries(summaryData)
        .map(([k, v]) => `ã€${k}ã€‘\n${v.join("\n") || "ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰"}`)
        .join("\n\n");
      document.getElementById("summary").textContent = `ã€ç”Ÿæ´»æƒ…å ±ã¾ã¨ã‚ã€‘\n` + sumtxt;
    };

    const chat = async (messages) => {
      const res = await fetchJSON("https://aichat.sabae.cc/api/conversation", messages);
      const div2 = document.createElement("div");
      div2.className = "assistant";
      const ss = res.split("\n\n");
      div2.textContent = ss[0];
      document.getElementById("view").appendChild(div2);
      speak(ss[0]);
      logs.push(ss[0]);
      updateSummary(ss[0]);

      for (let i = 1; i < ss.length; i++) {
        await sleep(1500);
        div2.textContent += "\n\n" + ss[i];
        speak(ss[i]);
        logs.push(ss[i]);
        updateSummary(ss[i]);
      }
    };

    const startApp = async () => {
      document.getElementById("startmsg").style.display = "none";

      const messages = [
        { role: "system", content: systemcontent },
        { role: "user", content: "ã“ã‚“ã«ã¡ã¯" },
      ];
      await chat(messages);

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recognition = new SR();
        recognition.lang = "ja-JP";
        recognition.interimResults = false;
        recognition.continuous = true;

        recognition.onresult = (event) => {
          const text = event.results[event.results.length - 1][0].transcript;
          const history = Array.from(document.getElementById("view").children).map(d => d.textContent);
          const messages = history.slice(-10).map((content, i) => ({
            role: i % 2 === 0 ? "assistant" : "user",
            content
          }));
          messages.unshift({ role: "system", content: systemcontent });
          messages.push({ role: "user", content: text });
          chat(messages);
        };

        recognition.onerror = (event) => {
          console.error("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:", event.error);
          recognition.stop();
          setTimeout(() => recognition.start(), 1000);
        };

        recognition.onend = () => recognition.start();

        recognition.start();
      }
    };

    document.getElementById("stop").onclick = () => {
      if (recognition) {
        recognition.stop();
        alert("ä¼šè©±ã‚’æ­¢ã‚ã¾ã—ãŸã€‚");
      }
    };

    window.addEventListener("click", () => {
      startApp();
    }, { once: true });

    document.getElementById("pdf").onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;

      // åå‰ã®æŠ½å‡º
      const nameMatch = logs.find(l => /åå‰|ã‚ãŸã—.*(ã§ã™|ã¯)/.test(l));
      let userName = "ï¼ˆåå‰æœªç¢ºèªï¼‰";
      if (nameMatch) {
        const m = nameMatch.match(/(?:åå‰ã¯|ã‚ãŸã—ã¯|ã¼ãã¯|ã‚ãŸã—ã®åå‰ã¯|ã¼ãã®åå‰ã¯)?\s*([\p{Script=Hiragana}\p{Script=Katakana}\p{Script=Han}a-zA-Z0-9]+)/u);
        if (m && m[1]) {
          userName = m[1] + " ã•ã‚“";
        }
      }

      doc.setFontSize(14);
      doc.text(`èŒ¶ã£ã¨ãƒ¼ã åŒ»å¸«å‘ã‘è¨˜éŒ²ï¼ˆ${userName}ï¼‰`, 10, y);
      y += 10;
      doc.setFontSize(10);
      doc.text(`ä½œæˆæ—¥æ™‚: ${new Date().toLocaleString()}`, 10, y);
      y += 10;

      for (const [key, value] of Object.entries(summaryData)) {
        if (y > 270) { doc.addPage(); y = 10; }
        doc.setFontSize(12);
        doc.text(`ã€${key}ã€‘`, 10, y); y += 8;
        if (value.length === 0) {
          doc.setFontSize(10);
          doc.text("ï¼ˆæƒ…å ±ãªã—ï¼‰", 12, y); y += 8;
        } else {
          value.forEach(item => {
            const lines = doc.splitTextToSize("- " + item, 180);
            lines.forEach(line => {
              if (y > 270) { doc.addPage(); y = 10; }
              doc.text(line, 12, y); y += 6;
            });
          });
        }
        y += 4;
      }

      const lifestyle = logs.filter(t => t.includes("ã•ã‚“ã½") || t.includes("ã¦ã‚Œã³") || t.includes("ã¨ã‚‚ã ã¡") || t.includes("ã„ãˆ") || t.includes("ã—ã‚…ã¿") || t.includes("ã©ã†ã™ã”"));
      if (lifestyle.length) {
        if (y > 270) { doc.addPage(); y = 10; }
        doc.setFontSize(12);
        doc.text("ã€ç”Ÿæ´»ã®éã”ã—æ–¹ã€‘", 10, y); y += 8;
        lifestyle.forEach(item => {
          const lines = doc.splitTextToSize("- " + item, 180);
          lines.forEach(line => {
            if (y > 270) { doc.addPage(); y = 10; }
            doc.setFontSize(10);
            doc.text(line, 12, y); y += 6;
          });
        });
        y += 5;
      }

      doc.setFontSize(12);
      doc.text("ã€ä¼šè©±å…¨ä½“è¨˜éŒ²ã€‘", 10, y);
      y += 8;
      logs.forEach(entry => {
        const lines = doc.splitTextToSize(entry, 180);
        lines.forEach(line => {
          if (y > 270) { doc.addPage(); y = 10; }
          doc.setFontSize(10);
          doc.text(line, 12, y); y += 6;
        });
        y += 4;
      });

      doc.save("chat-summary-medical.pdf");
    };
  </script>
</body>
</html>
